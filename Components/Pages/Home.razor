@page "/"
@using Timeline_Note_Taker.Models
@using Timeline_Note_Taker.Components.Shared
@inject Timeline_Note_Taker.Services.DatabaseService DbService
@inject Timeline_Note_Taker.Services.NoteEventService NoteEventService
@inject Timeline_Note_Taker.Services.LocalizationService Loc
@implements IDisposable

<div class="timeline-container">
    <div class="app-header">
        <h1>@Loc["app_title"]</h1>
        <a href="/settings" class="btn btn-icon settings-btn" title="@Loc["settings_title"]">⚙️</a>
    </div>

    <AddNote OnNoteSaved="OnNoteSaved" />
    
    <TimelineFilter DateFilter="@currentFilter" 
                    DateFilterChanged="OnFilterChanged" 
                    OnSearch="OnSearch"
                    OnWeekFiltered="OnWeekFiltered"
                    OnMonthFiltered="OnMonthFiltered"
                    OnTimeFiltered="OnTimeFiltered"
                    Topics="@allTopics"
                    OnTopicFilterChanged="OnTopicFilterChanged"
                    OnTypeFilterChanged="OnTypeFilterChanged" />
    
    @if (isLoading)
    {
        <div class="empty-state">
            <div class="empty-state-icon">⏳</div>
            <h3>@Loc["empty_state_loading"]</h3>
        </div>
    }
    else if (!groupedNotes.Any())
    {
        <div class="empty-state">
            <div class="empty-state-icon">📝</div>
            <h3>@Loc["empty_state_no_notes"]</h3>
            <p>@Loc["empty_state_start"]</p>
        </div>
    }
    else
    {
        @foreach (var group in groupedNotes)
        {
            <div class="timeline-date-group">
                <div class="timeline-date-header">
                    @GetDateLabel(group.Key)
                </div>
                <div class="timeline-list">
                    @foreach (var note in group)
                    {
                        <NoteCard Note="@note" OnDeleted="() => DeleteNote(note)" />
                    }
                </div>
            </div>
        }
    }
</div>

@code {
    private List<Note> notes = new();
    private List<string> allTopics = new();
    private IEnumerable<IGrouping<DateTime, Note>> groupedNotes = Enumerable.Empty<IGrouping<DateTime, Note>>();
    private TimelineFilter.DateFilterOption currentFilter = TimelineFilter.DateFilterOption.Today;
    private string searchTerm = string.Empty;
    private string? topicFilter = null;
    private NoteType? typeFilter = null;
    private bool isLoading = true;

    // protected override async Task OnInitializedAsync()
    // {
    //     // Subscribe to note saved events
    //     NoteEventService.NoteSaved += OnNoteEventTriggered;
        
    //     await LoadTopics();
    //     await LoadNotes();
    // }

    public void Dispose()
    {
        // Unsubscribe from events
        NoteEventService.NoteSaved -= OnNoteEventTriggered;
        Loc.OnLanguageChanged -= OnLanguageChanged;
    }

    private void OnLanguageChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private async void OnNoteEventTriggered()
    {
        // Refresh timeline when note is saved from Quick Note window
        await InvokeAsync(async () =>
        {
            // Add a small delay to ensure DB write is complete and to debounce if needed
            await Task.Delay(100);
            await OnNoteSaved();
            StateHasChanged();
        });
    }

    private async Task LoadTopics()
    {
        allTopics = await DbService.GetAllTopicsAsync();
    }

    private async Task OnNoteSaved()
    {
        await LoadTopics();
        await LoadNotes();
    }

    // Filter state
    private DateTime? weeklyStart;
    private DateTime? weeklyEnd;
    private DateTime? monthlyStart;
    private DateTime? monthlyEnd;
    private TimeSpan? filterStartTime;
    private TimeSpan? filterEndTime;
    
    protected override async Task OnInitializedAsync()
    {
        // Subscribe to note saved events
        NoteEventService.NoteSaved += OnNoteEventTriggered;
        Loc.OnLanguageChanged += OnLanguageChanged;
        
        await LoadTopics();
        await LoadNotes();
    }
    
    // ... Dispose and OnNoteEventTriggered ... 

    private async Task OnWeekFiltered((DateTime Start, DateTime End) range)
    {
        weeklyStart = range.Start;
        weeklyEnd = range.End;
        await LoadNotes();
    }

    private async Task OnMonthFiltered((DateTime Start, DateTime End) range)
    {
        monthlyStart = range.Start;
        monthlyEnd = range.End;
        await LoadNotes();
    }

    private async Task OnTimeFiltered((TimeSpan? Start, TimeSpan? End) range)
    {
        filterStartTime = range.Start;
        filterEndTime = range.End;
        await LoadNotes();
    }

    private async Task LoadNotes()
    {
        isLoading = true;
        StateHasChanged();

        // 1. Get Base Set by Date
        List<Note> fetchedNotes;
        
        if (currentFilter == TimelineFilter.DateFilterOption.Today)
        {
            fetchedNotes = await DbService.GetTodaysNotesAsync();
        }
        else if (currentFilter == TimelineFilter.DateFilterOption.ThisWeek)
        {
            // If we have a custom week selected, use it. Otherwise default to this week logic (fallback)
            if (weeklyStart.HasValue && weeklyEnd.HasValue)
            {
                // Add 1 day to end date to include the full day (since timestamps vary)
                // Actually GetNotesByDateRangeAsync handles strict comparison usually.
                // DbService comparison is (n.CreatedAt >= startDate && n.CreatedAt <= endDate)
                // If endDate is at 00:00:00, it misses the day. So ensure end of day.
                var endOfRange = weeklyEnd.Value.Date.AddDays(1).AddTicks(-1);
                fetchedNotes = await DbService.GetNotesByDateRangeAsync(weeklyStart.Value, endOfRange);
            }
            else
            {
                fetchedNotes = await DbService.GetThisWeeksNotesAsync();
            }
        }
        else if (currentFilter == TimelineFilter.DateFilterOption.ThisMonth)
        {
             if (monthlyStart.HasValue && monthlyEnd.HasValue)
            {
                 fetchedNotes = await DbService.GetNotesByDateRangeAsync(monthlyStart.Value, monthlyEnd.Value);
            }
            else
            {
                 fetchedNotes = await GetThisMonthsNotes();
            }
        }
        else
        {
            fetchedNotes = await DbService.GetAllNotesAsync();
        }

        notes = fetchedNotes;

        // 2. Apply In-Memory Filters (Time, Topic, Type, Search)

        // Time Filter
        if (filterStartTime.HasValue)
        {
            notes = notes.Where(n => n.CreatedAt.TimeOfDay >= filterStartTime.Value).ToList();
        }
        if (filterEndTime.HasValue)
        {
            notes = notes.Where(n => n.CreatedAt.TimeOfDay <= filterEndTime.Value).ToList();
        }

        // Apply topic filter
        if (!string.IsNullOrEmpty(topicFilter))
        {
            notes = notes.Where(n => n.Topic == topicFilter).ToList();
        }

        // Apply type filter
        if (typeFilter.HasValue)
        {
            notes = notes.Where(n => n.Type == typeFilter.Value).ToList();
        }

        // Apply search filter
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var lowerSearch = searchTerm.ToLower();
            notes = notes.Where(n =>
                (n.Content?.ToLower().Contains(lowerSearch) ?? false) ||
                (n.Topic?.ToLower().Contains(lowerSearch) ?? false) ||
                (n.Tags?.ToLower().Contains(lowerSearch) ?? false)
            ).ToList();
        }

        // Group by date
        groupedNotes = notes.GroupBy(n => n.CreatedAt.Date)
                           .OrderByDescending(g => g.Key);

        isLoading = false;
        StateHasChanged();
    }

    private async Task<List<Note>> GetThisMonthsNotes()
    {
        var today = DateTime.Today;
        var startOfMonth = new DateTime(today.Year, today.Month, 1);
        var endOfMonth = startOfMonth.AddMonths(1);
        return await DbService.GetNotesByDateRangeAsync(startOfMonth, endOfMonth);
    }

    private async Task OnFilterChanged(TimelineFilter.DateFilterOption filter)
    {
        currentFilter = filter;
        await LoadNotes();
    }

    private async Task OnSearch(string term)
    {
        searchTerm = term;
        await LoadNotes();
    }

    private async Task OnTopicFilterChanged(string? topic)
    {
        topicFilter = topic;
        await LoadNotes();
    }

    private async Task OnTypeFilterChanged(NoteType? type)
    {
        typeFilter = type;
        await LoadNotes();
    }

    private async Task DeleteNote(Note note)
    {
        await DbService.DeleteNoteAsync(note);
        await LoadNotes();
    }

    private string GetDateLabel(DateTime date)
    {
        var today = DateTime.Today;
        
        if (date == today)
            return "Today";
        if (date == today.AddDays(-1))
            return "Yesterday";
        if (date > today.AddDays(-7))
            return date.ToString("dddd");
        if (date.Year == today.Year)
            return date.ToString("MMMM d");
        
        return date.ToString("MMMM d, yyyy");
    }
}
